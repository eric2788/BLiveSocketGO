<!DOCTYPE html>
<html>

<head>
    <title>测试获取B站直播数据</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1, width=device-width" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />

</head>

<body>
    <div id="app"></div>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@material-ui/core@4.12.3/umd/material-ui.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="text/javascript">
        const API_HOST = 'blive.chu77.xyz'
        const SCHEMA = 's'
    </script>
    <script type="text/javascript" src="js/websocket.js"></script>
    <script type="text/javascript" src="js/subscribe.js"></script>
    <script type="text/javascript" src="js/bliveformatter.js"></script>
    <script type="text/babel">

        const {
            Container,
            Box,
            AppBar,
            Toolbar,
            Typography,
            ThemeProvider,
            createTheme,
            Card,
            CssBaseline,
            CardContent,
            CardActions,
            Button,
            Grid,
            TextField,
            Divider,
            Dialog,
            DialogTitle,
            DialogContent,
            DialogContentText,
            DialogActions,
            SnakeBar,
            Switch,
            CircularProgress,
            List,
            ListItem,
            ListItemText,
            ListItemSecondaryAction
        } = MaterialUI

        const { useState, useEffect } = React

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false };
            }

            static getDerivedStateFromError(error) {
                return {
                    hasError: true
                };
            }
            componentDidCatch(error, errorInfo) {
                console.warn(error, errorInfo)
            }

            render() {
                if (this.state.hasError) {
                    return <h1>Something went wrong.</h1>;
                }
                return this.props.children;
            }
        }


        function ErrorDialog(props) {

            if (!props.error) {
                return null
            }

            return (
                <Dialog
                    open={!!props.error}
                    onClose={props.onClose}
                    maxWidth="md"
                    fullWidth
                >
                    <DialogTitle sx={{ color: 'red' }}>
                        <b style={{ color: 'red' }}>{props.error.title}</b>
                    </DialogTitle>
                    <DialogContent>
                        <DialogContentText>
                            {props.error.message}
                        </DialogContentText>
                    </DialogContent>
                    <DialogActions>
                        <Button onClick={props.onClose}>确定</Button>
                    </DialogActions>
                </Dialog>
            );
        }


        function TopAppBar(props) {

            const ref = React.createRef()

            return (
                <AppBar position="relative" color="secondary">
                    <Toolbar variant="dense" style={{ display: 'flex', flexDirection: 'row', justifyContent: 'space-between' }}>
                        <Typography variant="h6" component="div">
                            {props.name}
                        </Typography>
                        <Box style={{ float: 'right' }}>
                            切换深色
                            <Switch ref={ref} color="primary" onChange={props.onSwitchDark} checked={props.dark} />
                        </Box>
                    </Toolbar>
                </AppBar>
            )
        }

        function ContentRow(props, ref) {
            const { index, style, data } = props

            return (
                <ListItem style={style} key={index} ref={data.length - 1 == index ? ref : null}>
                    <ListItemText>
                        {data[index]}
                    </ListItemText>
                </ListItem>
            )
        }

        function ContentList(props) {

            const started = props.started
            const loading = props.loading


            const handleClick = () => {
                if (started) {
                    props.onStop()
                } else {
                    props.onStart()
                }
            }

            return (
                <Box>
                    <Grid container alignItems="center" justifyContent="space-between">
                        <h3>房间讯息</h3>
                        <Box style={{ float: 'right' }}>
                            保持置底
                            <Switch onChange={props.onSwitchBottom} checked={props.contentBottom} />
                        </Box>
                    </Grid>
                    <Card>
                        <CardContent style={{ height: '500px', overflowWrap: 'break-word', overflowY: 'auto' }}>
                            <ErrorBoundary>
                                <List dense>
                                    {
                                        props.list.map(data => BLiveDataFomatter({ data })).filter(d => !!d)
                                            .map((line, i, arr) => (
                                                <ListItem key={i} ref={arr.length - 1 == i ? props.hook : null}>
                                                    <ListItemText>
                                                        {line}
                                                    </ListItemText>
                                                </ListItem>
                                            ))
                                    }
                                </List>
                            </ErrorBoundary>
                        </CardContent>
                        <Divider />
                        <CardActions style={{ height: '70px' }}>
                            <Button fullWidth variant="outlined" color="primary" disabled={loading} onClick={handleClick}>
                                {started ? '中止' : '启动'}监听
                            </Button>
                        </CardActions>
                    </Card>
                </Box>
            )
        }


        function ErrorAlert(props) {

            if (!props.error) return null

            return (
                <Grid
                    alignItems="center"
                    justifyContent="center"
                    container
                    style={{
                        height: '100%',
                        width: '100%',
                        padding: 0
                    }}
                >
                    <h4 style={{ color: 'red' }}> {props.error} </h4>
                </Grid>
            )
        }


        function LoadingGrid() {

            return (
                <Grid
                    alignItems="center"
                    justifyContent="center"
                    container
                    style={{
                        height: '100%',
                        width: '100%',
                        padding: 0
                    }}
                >
                    <CircularProgress />
                </Grid>
            )
        }

        function SubscribeList(props) {

            const loading = props.loading
            const starting = props.starting || false

            const onEnter = (e) => {
                if (e.charCode !== 13) return
                if (!e.target.value) return
                const room = Number.parseInt(e.target.value)
                if (isNaN(room)) {
                    alert('请输入有效的数字')
                    return
                }
                if (room < 0) {
                    alert('不能为负数')
                    return
                }
                e.target.value = ''
                if (props.list.includes(room)) {
                    props.onError({
                        title: '添加失败',
                        message: `房间 ${room} 已在名单内。`
                    })
                    return
                }
                props.onAddSub(room)
            }

            let content;

            if (loading) {
                content = <LoadingGrid />
            } else {
                content = (
                    <List dense>
                        {
                            props.list.map((sub, i, arr) => (
                                <ListItem key={sub} ref={arr.length - 1 == i ? props.hook : null}>
                                    <ListItemText>
                                        {sub}
                                    </ListItemText>
                                    <ListItemSecondaryAction>
                                        <Button color="primary" onClick={() => props.onDelete(sub)} disabled={starting}>删除</Button>
                                    </ListItemSecondaryAction>
                                </ListItem>
                            ))
                        }
                    </List>
                )
            }

            return (
                <Box>
                    <h3>订阅列表</h3>
                    <Card sx={{ scrollY: 'auto' }}>
                        <CardContent style={{ height: '500px', overflowY: 'auto', overflowX: 'hidden' }}>
                            {content}
                        </CardContent>
                        <Divider />
                        <CardActions style={{ height: '70px' }}>
                            <TextField
                                type="number"
                                min={1}
                                disabled={loading || starting}
                                label="新增订阅 (Enter 新增)"
                                fullWidth
                                variant="standard"
                                onKeyPress={onEnter}
                            />
                        </CardActions>
                    </Card>
                </Box>
            )
        }


        class SubscribePanel extends React.Component {

            constructor(props) {
                super(props)
                this.state = {
                    loading: false,
                    sub: [],
                    content: [],
                    started: false,
                    bottom: true
                }
                this.updateState = this.updateState.bind(this)
                this.startListen = this.startListen.bind(this)
                this.stopListen = this.stopListen.bind(this)
                this.handleError = this.handleError.bind(this)
                this.onAddSubscribe = this.onAddSubscribe.bind(this)
                this.onDeleteSubscribe = this.onDeleteSubscribe.bind(this)
                this.onUpdateMessage = this.onUpdateMessage.bind(this)
                this.onSwitchBottom = this.onSwitchBottom.bind(this)

                this.contentRef = React.createRef()
                this.subscribeRef = React.createRef()
            }

            async updateState(update) {
                return new Promise((res,) => this.setState(update, res))
            }


            startListen() {
                if (this.state.started) {
                    this.props.onError({
                        title: '尝试打开WebSocket连接时发生错误',
                        message: '一个连接已经开启，请关闭后再打开'
                    })
                    return
                }
                this.updateState({
                    loading: true,
                    content: []
                }).then(() => subscribes(this.state.sub))
                    .then(sub => this.updateState({ sub }))
                    .then(() => this.updateState({ loading: false, started: true }))
                    .then(() => connect(this.onUpdateMessage))
                    .catch(err => {
                        let errMessage;
                        if (err.response) {
                            errMessage = err.response.data.error
                        } else if (err.target) {
                            errMessage = `WebSocket 连接失败`
                        } else {
                            errMessage = err.message || err
                        }
                        console.warn(`错误: ${errMessage}`)
                        console.warn(err)
                        this.props.onError({
                            title: '递交订阅或連接WS时出现错误',
                            message: errMessage
                        })
                    })
                    .finally(() => this.updateState({ loading: false }))
            }

            onSwitchBottom(e) {
                this.updateState({ bottom: e.target.checked })
            }

            onUpdateMessage(data) {
                this.updateState((state, props) => {
                    const newContent = [...state.content, data]
                    //防止过多，限制最大元素 150
                    newContent.splice(0, newContent.length - 150)
                    return {
                        content: newContent
                    }
                })
                    .then(() => {
                        if (this.state.bottom && this.contentRef.current) {
                            this.contentRef.current.scrollIntoView({ behavior: 'smooth' })
                        }
                    })
            }

            stopListen() {
                this.updateState({
                    loading: true
                })
                    .then(() => disconnect())
                    .finally(() => this.updateState({
                        started: false,
                        loading: false
                    }))
            }

            onAddSubscribe(room) {
                this.updateState((state, props) => ({
                    sub: [...state.sub, room]
                }))
                    .then(() => this.subscribeRef.current.scrollIntoView({ behavior: 'smooth' }))
            }

            onDeleteSubscribe(room) {
                const newSub = [...this.state.sub]
                newSub.splice(newSub.indexOf(room), 1)
                this.updateState({
                    sub: newSub
                })
            }



            handleError(err) {
                this.props.onError(err)
            }

            componentDidMount() {
                this.updateState({ loading: true })
                    .then(() => getSubscribtions())
                    .then(sub => this.updateState({ sub: sub }))
                    .catch(err => {
                        const errMessage = err.message || err
                        console.warn(`错误: ${errMessage}`)
                        console.warn(err)
                        this.props.onError({
                            title: '尝试获取订阅列表时出现错误',
                            message: errMessage
                        })
                    }).finally(() => this.updateState({ loading: false }))
            }

            render() {
                return (
                    <Grid alignItems="center" justifyContent="center" container spacing={2}>
                        <Grid item lg={3} md={12} sm={12} xs={12}>
                            <SubscribeList
                                loading={this.state.loading}
                                onError={this.handleError}
                                list={this.state.sub}
                                onAddSub={this.onAddSubscribe}
                                onDelete={this.onDeleteSubscribe}
                                starting={this.state.started}
                                hook={this.subscribeRef}
                            />
                        </Grid>
                        <Grid item lg={9} md={12} sm={12} xs={12}>
                            <ContentList
                                onError={this.handleError}
                                list={this.state.content}
                                loading={this.state.loading}
                                onStart={this.startListen}
                                onStop={this.stopListen}
                                started={this.state.started}
                                hook={this.contentRef}
                                contentBottom={this.state.bottom}
                                onSwitchBottom={this.onSwitchBottom}
                            />
                        </Grid>
                    </Grid>
                )
            }
        }

        function App() {

            const lightTheme = createTheme({
                palette: {
                    type: 'light',
                    primary: {
                        main: '#FF4081'
                    },
                    secondary: {
                        main: '#3949AB'
                    }
                }
            })

            const darkTheme = createTheme({
                palette: {
                    type: 'dark',
                    primary: {
                        main: '#bdbdbd'
                    },
                    secondary: {
                        main: '#424242'
                    }
                },
            });

            const [dark, setDark] = useState(false)
            const [error, setError] = useState(undefined)
            const handleError = (err) => setError(err)

            useEffect(() => {
                const systemDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
                const storageDark = localStorage['dark'] === 'true'
                setDark(localStorage['dark'] ? storageDark : systemDark)
            }, [])

            const onSwitchDark = (e) => {
                setDark(e.target.checked)
                localStorage['dark'] = e.target.checked
            }

            return (
                <ThemeProvider theme={dark ? darkTheme : lightTheme}>
                    <CssBaseline />
                    <TopAppBar name={document.title} onSwitchDark={onSwitchDark} dark={dark} />
                    <CssBaseline />
                    <Box sx={{ mt: 5, align: 'center', mx: 10 }}>
                        <ErrorDialog error={error} onClose={() => setError(undefined)} />
                        <SubscribePanel onError={handleError} />
                    </Box>
                </ThemeProvider>
            )
        }


        ReactDOM.render(<App />, document.getElementById("app"))
    </script>
</body>

</html>